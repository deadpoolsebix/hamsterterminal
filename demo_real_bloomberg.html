<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hamster Terminal - Bloomberg Professional Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bloomberg-orange: #ff8c00;
            --bloomberg-burgundy: #800020;
            --bg-black: #000000;
            --bg-dark: #0a0a0a;
            --text-white: #ffffff;
            --text-gray: #cccccc;
            --green-positive: #00ff00;
            --red-negative: #ff0033;
            --border-gray: #333333;
        }

        body {
            background: var(--bg-black);
            color: var(--text-white);
            font-family: 'Roboto Mono', monospace;
            font-size: 13px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        /* BLOOMBERG HEADER */
        .bloomberg-header {
            background: var(--bloomberg-orange);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0;
        }

        .bloomberg-title {
            font-family: 'Roboto Mono', monospace;
            font-size: 16px;
            font-weight: 700;
            color: #000000;
            letter-spacing: 1px;
        }

        .bloomberg-time {
            font-family: 'Roboto Mono', monospace;
            font-size: 13px;
            color: #000000;
            font-weight: 500;
        }

        /* BURGUNDY MENU BAR */
        .menu-bar {
            background: var(--bloomberg-burgundy);
            padding: 10px 20px;
            display: flex;
            gap: 25px;
            border-radius: 0;
        }

        .menu-item {
            color: var(--text-white);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .menu-item:hover {
            opacity: 0.8;
        }

        .menu-item.active {
            font-weight: 700;
            text-decoration: underline;
        }

        /* MAIN CONTENT */
        .main-content {
            padding: 15px 20px;
        }

        /* SECTION HEADER */
        .section-header {
            background: var(--bg-dark);
            padding: 10px 15px;
            margin-bottom: 2px;
            border-left: 4px solid var(--bloomberg-orange);
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-white);
        }

        .section-subtitle {
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 3px;
        }

        /* DATA TABLE */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: var(--bg-black);
        }

        .data-table thead th {
            background: var(--bg-dark);
            color: var(--bloomberg-orange);
            padding: 8px 12px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            border-bottom: 2px solid var(--bloomberg-orange);
            border-right: 1px solid var(--border-gray);
        }

        .data-table thead th:last-child {
            border-right: none;
        }

        .data-table tbody td {
            padding: 6px 12px;
            border-right: 1px solid var(--border-gray);
            border-bottom: 1px solid var(--border-gray);
            font-size: 12px;
            font-weight: 500;
        }

        .data-table tbody td:last-child {
            border-right: none;
        }

        .data-table tbody tr:hover {
            background: var(--bg-dark);
        }

        /* ROW HEADER */
        .data-table tbody td.row-header {
            color: var(--bloomberg-orange);
            font-weight: 700;
            cursor: pointer;
        }

        .data-table tbody td.row-header:hover {
            text-decoration: underline;
        }

        /* VALUE COLORS */
        .value-positive {
            color: var(--green-positive);
            background: rgba(0, 255, 0, 0.1);
        }

        .value-negative {
            color: var(--red-negative);
            background: rgba(255, 0, 51, 0.1);
        }

        .value-neutral {
            color: var(--text-white);
        }

        /* METRICS GRID */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-box {
            background: var(--bg-dark);
            border: 1px solid var(--border-gray);
            border-left: 4px solid var(--bloomberg-orange);
            padding: 15px;
            border-radius: 0;
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-gray);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-white);
            margin-bottom: 5px;
        }

        .metric-change {
            font-size: 13px;
            font-weight: 500;
        }

        .metric-change.up {
            color: var(--green-positive);
        }

        .metric-change.down {
            color: var(--red-negative);
        }

        /* CHART PLACEHOLDER */
        .chart-container {
            background: var(--bg-dark);
            border: 1px solid var(--border-gray);
            height: 400px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0;
        }

        .chart-placeholder {
            color: var(--text-gray);
            font-size: 14px;
        }

        /* PANELS */
        .panel-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .panel {
            background: var(--bg-dark);
            border: 1px solid var(--border-gray);
            border-radius: 0;
        }

        .panel-header {
            background: var(--bg-black);
            padding: 10px 15px;
            border-bottom: 2px solid var(--bloomberg-orange);
            font-size: 13px;
            font-weight: 700;
            color: var(--text-white);
        }

        .panel-content {
            padding: 15px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-gray);
            font-size: 12px;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-label {
            color: var(--text-gray);
            font-weight: 500;
        }

        .data-value {
            color: var(--text-white);
            font-weight: 700;
        }

        /* INDICATOR PANEL */
        .indicator-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-gray);
        }

        .indicator-item:last-child {
            border-bottom: none;
        }

        .indicator-name {
            color: var(--text-gray);
            font-size: 12px;
            font-weight: 500;
        }

        .indicator-value {
            font-size: 14px;
            font-weight: 700;
        }

        /* SIGNAL BOX */
        .signal-box {
            background: var(--bg-black);
            border: 2px solid var(--bloomberg-orange);
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
        }

        .signal-title {
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            color: var(--bloomberg-orange);
            margin-bottom: 15px;
        }

        .signal-value {
            font-size: 36px;
            font-weight: 900;
            color: var(--green-positive);
            margin: 15px 0;
        }

        .signal-confidence {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 10px;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: var(--border-gray);
            border-radius: 0;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--green-positive);
            transition: width 0.5s;
        }

        /* FOOTER */
        .footer {
            background: var(--bg-dark);
            padding: 15px 20px;
            text-align: center;
            border-top: 2px solid var(--bloomberg-orange);
            margin-top: 20px;
        }

        .footer-text {
            font-family: 'Press Start 2P', monospace;
            font-size: 9px;
            color: var(--bloomberg-orange);
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .panel-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- BLOOMBERG HEADER -->
        <div class="bloomberg-header">
            <div class="bloomberg-title">üêπ BTC USD Crypto | HAMSTER TERMINAL</div>
            <div class="bloomberg-time" id="header-time">--:--:--</div>
        </div>

        <!-- MENU BAR -->
        <div class="menu-bar">
            <div class="menu-item active">Inflection</div>
            <div class="menu-item">KPI Correlation</div>
            <div class="menu-item">Trend Analysis</div>
            <div class="menu-item">Export ‚ñº</div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- SECTION HEADER -->
            <div class="section-header">
                <div class="section-title">Alternative Data Metrics Summary - Bitcoin Trading</div>
                <div class="section-subtitle">Data up to <span id="current-date">2026-01-19</span> | Real-time Trading Dashboard</div>
            </div>

            <!-- METRICS GRID -->
            <div class="metrics-grid">
                <div class="metric-box">
                    <div class="metric-label">CURRENT PRICE</div>
                    <div class="metric-value">$98,432.50</div>
                    <div class="metric-change up">‚ñ≤ +2,345.80 (+2.44%)</div>
                </div>

                <div class="metric-box">
                    <div class="metric-label">24H VOLUME</div>
                    <div class="metric-value">$2.4B</div>
                    <div class="metric-change up">‚ñ≤ +12.5%</div>
                </div>

                <div class="metric-box">
                    <div class="metric-label">MARKET CAP</div>
                    <div class="metric-value">$1.94T</div>
                    <div class="metric-change up">‚ñ≤ +1.87%</div>
                </div>

                <div class="metric-box">
                    <div class="metric-label">P&L TODAY</div>
                    <div class="metric-value">+$842.50</div>
                    <div class="metric-change up">‚ñ≤ +16.85% ROI</div>
                </div>
            </div>

            <!-- DATA TABLE -->
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ALT DATA METRICS</th>
                        <th>91 Day</th>
                        <th>28 Day</th>
                        <th>7 Day</th>
                        <th>1 Day</th>
                        <th>Current</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-header">Bloomberg Second Measure</td>
                        <td class="value-positive">2.57</td>
                        <td class="value-positive">5.34</td>
                        <td class="value-positive">7.64</td>
                        <td class="value-positive">7.27</td>
                        <td class="value-neutral">8.20</td>
                    </tr>
                    <tr>
                        <td class="row-header">Observed Sales</td>
                        <td class="value-positive">5.88</td>
                        <td class="value-positive">9.14</td>
                        <td class="value-positive">10.92</td>
                        <td class="value-positive">6.22</td>
                        <td class="value-negative">-5.71</td>
                    </tr>
                    <tr>
                        <td class="row-header">Observed Transactions</td>
                        <td class="value-neutral">5.88</td>
                        <td class="value-neutral">9.14</td>
                        <td class="value-positive">10.92</td>
                        <td class="value-positive">6.22</td>
                        <td class="value-negative">-5.71</td>
                    </tr>
                    <tr>
                        <td class="row-header">Observed Customers</td>
                        <td class="value-positive">3.22</td>
                        <td class="value-positive">7.08</td>
                        <td class="value-positive">10.33</td>
                        <td class="value-positive">4.11</td>
                        <td class="value-negative">-5.29</td>
                    </tr>
                    <tr>
                        <td class="row-header">Average Transaction Value</td>
                        <td class="value-negative">-3.12</td>
                        <td class="value-negative">-3.49</td>
                        <td class="value-negative">-2.96</td>
                        <td class="value-positive">0.99</td>
                        <td class="value-negative">-2.64</td>
                    </tr>
                    <tr>
                        <td class="row-header">Transactions per Customer</td>
                        <td class="value-positive">2.50</td>
                        <td class="value-positive">1.60</td>
                        <td class="value-positive">0.92</td>
                        <td class="value-positive">2.80</td>
                        <td class="value-negative">-0.78</td>
                    </tr>
                    <tr>
                        <td class="row-header">Sales per Customer</td>
                        <td class="value-negative">-0.63</td>
                        <td class="value-negative">-1.63</td>
                        <td class="value-negative">-2.44</td>
                        <td class="value-positive">3.04</td>
                        <td class="value-negative">-3.08</td>
                    </tr>
                    <tr>
                        <td class="row-header">Estimated Visits</td>
                        <td class="value-positive">6.61</td>
                        <td class="value-positive">12.21</td>
                        <td class="value-positive">15.28</td>
                        <td class="value-positive">10.70</td>
                        <td class="value-negative">-4.68</td>
                    </tr>
                </tbody>
            </table>

            <!-- CHART -->
            <div class="chart-container">
                <div class="chart-placeholder">[ LIVE TRADING CHART - Plotly Integration ]</div>
            </div>

            <!-- PANEL GRID -->
            <div class="panel-grid">
                <!-- LEFT PANEL: TECHNICAL INDICATORS -->
                <div class="panel">
                    <div class="panel-header">üìà TECHNICAL INDICATORS</div>
                    <div class="panel-content">
                        <div class="indicator-item">
                            <span class="indicator-name">RSI (14)</span>
                            <span class="indicator-value" style="color: #ffff00;">67.8</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-name">MACD</span>
                            <span class="indicator-value" style="color: #00ff00;">+234.5</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-name">EMA 20</span>
                            <span class="indicator-value">$97,845.00</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-name">EMA 50</span>
                            <span class="indicator-value">$95,234.00</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-name">MOMENTUM</span>
                            <span class="indicator-value" style="color: #00ff00;">BULLISH</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-name">ATR (14)</span>
                            <span class="indicator-value">$1,245.30</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-name">BOLLINGER BAND WIDTH</span>
                            <span class="indicator-value" style="color: #ffff00;">HIGH</span>
                        </div>
                    </div>
                </div>

                <!-- RIGHT PANEL: AI SIGNAL & ORDER BOOK -->
                <div>
                    <!-- AI SIGNAL -->
                    <div class="signal-box">
                        <div class="signal-title">üêπ AI HAMSTER SIGNAL</div>
                        <div class="signal-value" id="signalBadge">--</div>
                        <div class="signal-confidence" id="signalStrength">CONFIDENCE: --</div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" id="signalStrengthFill" style="width: 0%;"></div>
                        </div>
                        <div style="margin-top: 12px; font-size: 11px; color: #cccccc; display: grid; gap: 4px;">
                            <div id="signalStatus">‚Ä¢ Sygna≈Ç: --</div>
                            <div id="strengthStatus">‚Ä¢ Si≈Ça: --</div>
                            <div id="btcPriceStatus">‚Ä¢ BTC: --</div>
                            <div id="changeStatus">‚Ä¢ 24H: --</div>
                        </div>
                        <div id="liveCommentary" style="margin-top: 14px; padding: 12px; background: rgba(0, 212, 255, 0.08); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 4px; font-size: 12px; line-height: 1.6; color: #e6f7ff;">
                            Genius inicjalizuje‚Ä¶ oczekiwanie na odpowied≈∫ API.
                        </div>
                        <div id="geniusQuantPanel" style="margin-top: 12px; padding: 12px; background: rgba(255, 140, 0, 0.06); border: 1px solid rgba(255, 140, 0, 0.35); border-radius: 4px; font-size: 11px; line-height: 1.5; color: #ffe9cc;">
                            Quant Insights w trakcie ≈Çadowania‚Ä¶
                        </div>
                        <div id="geniusLiveBias" style="margin-top: 12px; font-size: 11px; color: #cccccc; line-height: 1.5;">
                            Live-bias zostanie pokazany po pierwszym pobraniu danych.
                        </div>
                        <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; font-size: 11px; color: #cccccc;">
                            <label for="geniusAudioLang" style="font-size: 11px;">Audio jƒôzyk:</label>
                            <select id="geniusAudioLang" style="background: #0a0a0a; color: #ffffff; border: 1px solid var(--border-gray); padding: 4px 8px; font-size: 11px;">
                                <option value="pl">PL</option>
                                <option value="en">EN</option>
                                <option value="de">DE</option>
                                <option value="sk">SK</option>
                            </select>
                            <button id="geniusAudioPlay" style="background: var(--bloomberg-orange); color: #000; border: none; padding: 6px 12px; font-size: 11px; font-weight: 700; cursor: pointer;">‚ñ∂ Audio Genius</button>
                            <span id="geniusAudioStatus" style="color: #aaaaaa; font-size: 10px;">Gotowe</span>
                        </div>
                    </div>

                    <!-- ORDER BOOK -->
                    <div class="panel">
                        <div class="panel-header">üìñ ORDER BOOK</div>
                        <div class="panel-content">
                            <div class="data-row">
                                <span class="data-label">$98,450</span>
                                <span class="data-value" style="color: #00ff00;">12.5 BTC</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">$98,440</span>
                                <span class="data-value" style="color: #00ff00;">8.3 BTC</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">$98,435</span>
                                <span class="data-value" style="color: #00ff00;">15.7 BTC</span>
                            </div>
                            <div class="data-row" style="border-color: #ff8c00; border-width: 2px;">
                                <span class="data-label" style="color: #ff8c00;">$98,432</span>
                                <span class="data-value" style="color: #ff8c00;">LAST</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">$98,420</span>
                                <span class="data-value" style="color: #ff0033;">9.2 BTC</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">$98,410</span>
                                <span class="data-value" style="color: #ff0033;">11.8 BTC</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">$98,400</span>
                                <span class="data-value" style="color: #ff0033;">6.4 BTC</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MARKET DATA PANEL -->
            <div class="panel">
                <div class="panel-header">üìä MARKET DATA</div>
                <div class="panel-content">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                        <div class="data-row" style="flex-direction: column; border: none;">
                            <span class="data-label">24H HIGH</span>
                            <span class="data-value" style="color: #00ff00;">$99,234.00</span>
                        </div>
                        <div class="data-row" style="flex-direction: column; border: none;">
                            <span class="data-label">24H LOW</span>
                            <span class="data-value" style="color: #ff0033;">$96,123.50</span>
                        </div>
                        <div class="data-row" style="flex-direction: column; border: none;">
                            <span class="data-label">CIRCULATING SUPPLY</span>
                            <span class="data-value">19.6M BTC</span>
                        </div>
                        <div class="data-row" style="flex-direction: column; border: none;">
                            <span class="data-label">DOMINANCE</span>
                            <span class="data-value">45.2%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <div class="footer-text">üêπ HAMSTER TERMINAL - BLOOMBERG PROFESSIONAL EDITION</div>
        </div>
    </div>

    <script>
        // Auto-play spoken intro using browser speech synthesis
        function playIntroAudio() {
            if (!('speechSynthesis' in window)) {
                return;
            }
            const utterance = new SpeechSynthesisUtterance('Cze≈õƒá, jestem Hamster Genius. Bƒôdƒô ci pomagaƒá w grze.');
            utterance.lang = 'pl-PL';
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }

        // Update time
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('header-time').textContent = timeStr;
            
            const dateStr = now.toISOString().split('T')[0];
            document.getElementById('current-date').textContent = dateStr;
        }

        const LOCAL_HOSTS = new Set(['localhost', '127.0.0.1', '0.0.0.0', '']);
        const productionApiBase = 'https://tutorials-gentle-operations-vatican.trycloudflare.com';
        const hostname = window.location.hostname;
        const isLocalhost = LOCAL_HOSTS.has(hostname);
        const API_BASE = isLocalhost ? 'http://localhost:5000' : productionApiBase;
        console.log(`üîå API Mode: ${isLocalhost ? 'LOCALHOST' : 'PRODUCTION'} | Base=${API_BASE}`);

        let geniusAudioHandle = null;
        let latestGeniusCommentary = '';

        const geniusSignalEmoji = {
            BULL: 'üöÄ',
            BEAR: 'üò±',
            NEUTRAL: 'ü§î'
        };

        function safeNumberText(value, decimals = 2, fallback = '--') {
            if (typeof value !== 'number' || !Number.isFinite(value)) {
                return fallback;
            }
            return value.toFixed(decimals);
        }

        function formatNumber(value, decimals = 2) {
            if (typeof value !== 'number' || !Number.isFinite(value)) {
                return '--';
            }
            return Number(value).toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        function formatStrengthLabel(strength) {
            if (!strength) {
                return '--';
            }
            const text = typeof strength === 'string' ? strength : String(strength);
            return text.trim().length ? text.toUpperCase() : '--';
        }

        function renderQuantPanel(report) {
            const panel = document.getElementById('geniusQuantPanel');
            if (!panel) return;

            if (!report || report.error) {
                panel.innerHTML = '‚ö†Ô∏è Quant engine offline ‚Äì oczekiwanie na backend.';
                return;
            }

            const insights = report.insights || {};
            const perf = insights.performance || {};
            const risk = insights.risk || {};
            const ffn = insights.ffn || {};
            const options = insights.options || {};
            const warnings = Array.isArray(report.warnings) ? report.warnings : [];

            const optionKeys = Object.keys(options);
            const firstOption = optionKeys.length ? options[optionKeys[0]] : null;
            let optionPrice = null;
            if (firstOption && typeof firstOption === 'object') {
                const candidates = [
                    firstOption.call_price,
                    firstOption.price,
                    firstOption.binomial_price,
                    firstOption.value,
                    firstOption.delta_call
                ];
                optionPrice = candidates.find(val => typeof val === 'number' && Number.isFinite(val)) ?? null;
            }

            const timestamp = typeof report.generated_at === 'number' && report.generated_at > 0
                ? new Date(report.generated_at * 1000).toLocaleTimeString()
                : new Date().toLocaleTimeString();

            const warningText = warnings.length
                ? `<div style="margin-top:6px; color:#ffbf80;">‚ö†Ô∏è ${warnings.slice(0, 2).join(' ‚Ä¢ ')}</div>`
                : '';

            panel.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <span style="color:#ffda9e; font-weight:700;">Quant Insights</span>
                    <span style="color:#ffd5a8; font-size:0.75em;">${timestamp}</span>
                </div>
                <div style="display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:8px; font-size:0.9em;">
                    <div style="background:rgba(0,255,65,0.08); border:1px solid rgba(0,255,65,0.25); padding:6px; border-radius:3px;">
                        <div style="color:#9fff9f; font-weight:700;">œÉ 1d</div>
                        <div>${safeNumberText(perf.daily_volatility, 3)}</div>
                    </div>
                    <div style="background:rgba(255,204,0,0.08); border:1px solid rgba(255,204,0,0.25); padding:6px; border-radius:3px;">
                        <div style="color:#ffcc66; font-weight:700;">VaR 95%</div>
                        <div>${safeNumberText(risk.value_at_risk, 4)}</div>
                    </div>
                    <div style="background:rgba(187,134,252,0.08); border:1px solid rgba(187,134,252,0.25); padding:6px; border-radius:3px;">
                        <div style="color:#bb86fc; font-weight:700;">Sharpe*</div>
                        <div>${safeNumberText(perf.sharpe_like, 2)}</div>
                    </div>
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; font-size:0.85em;">
                    ${typeof ffn.cagr === 'number' ? `<span style="background:rgba(0,212,255,0.08); border:1px solid rgba(0,212,255,0.3); padding:4px 6px; border-radius:3px; color:#00d4ff;">FFN CAGR ${(ffn.cagr * 100).toFixed(2)}%</span>` : ''}
                    ${optionPrice !== null ? `<span style="background:rgba(255,0,51,0.1); border:1px solid rgba(255,0,51,0.25); padding:4px 6px; border-radius:3px; color:#ff6688;">Option ${optionPrice.toFixed(2)}</span>` : ''}
                    ${typeof perf.sortino_like === 'number' ? `<span style="background:rgba(0,255,65,0.1); border:1px solid rgba(0,255,65,0.25); padding:4px 6px; border-radius:3px; color:#7dff7d;">Sortino ${safeNumberText(perf.sortino_like, 2)}</span>` : ''}
                </div>
                ${warningText}
            `;
        }

        function renderLiveBias(liveBias) {
            const container = document.getElementById('geniusLiveBias');
            if (!container) return;

            if (!liveBias || typeof liveBias !== 'object') {
                container.textContent = 'Brak aktualnych danych live-bias.';
                return;
            }

            const mtfFocus = (liveBias.mtfFocus || [])
                .map(item => {
                    if (!item) return '';
                    const tag = typeof item === 'string' ? item : (item.label || item.note || '');
                    return tag ? `<span style="background: rgba(255,140,0,0.12); border: 1px solid rgba(255,140,0,0.35); padding: 2px 6px; margin-right: 6px; border-radius: 3px; color: #ffcc91;">${tag}</span>` : '';
                })
                .filter(Boolean)
                .join(' ');

            const contextNotes = (liveBias.recentContext || [])
                .map(item => {
                    if (!item) return '';
                    const note = typeof item === 'string' ? item : (item.note || item.label || '');
                    return note ? `<li>${note}</li>` : '';
                })
                .filter(Boolean)
                .join('');

            container.innerHTML = `
                <div style="color:#ffe0b3; font-weight:700; margin-bottom:4px;">Bias: ${liveBias.primaryBias?.toUpperCase() || 'N/A'} ‚Ä¢ Playbook: ${liveBias.playbook || '--'}</div>
                <div style="margin-bottom:6px;">MTF Focus: ${mtfFocus || '‚Äî'}</div>
                <div>Sentiment: ${liveBias.sentimentShift || '--'} ‚Ä¢ Wolumen: ${liveBias.volumeNote || '--'}</div>
                <div style="margin-top:4px;">Callout: ${liveBias.sessionCallout || '--'}</div>
                ${contextNotes ? `<div style="margin-top:6px; color:#ffd2a3; font-size:0.95em;">Ostatnie notatki:<ul style="margin-left:16px; margin-top:4px;">${contextNotes}</ul></div>` : ''}
            `;
        }

        function applyGeniusPayload(payload) {
            const signalStatusEl = document.getElementById('signalStatus');
            const strengthStatusEl = document.getElementById('strengthStatus');
            const btcStatusEl = document.getElementById('btcPriceStatus');
            const changeStatusEl = document.getElementById('changeStatus');
            const commentaryEl = document.getElementById('liveCommentary');
            const signalBadgeEl = document.getElementById('signalBadge');
            const signalStrengthEl = document.getElementById('signalStrength');
            const signalStrengthFillEl = document.getElementById('signalStrengthFill');

            if (!payload || typeof payload !== 'object') {
                if (signalStatusEl) signalStatusEl.textContent = '‚Ä¢ Sygna≈Ç: --';
                if (strengthStatusEl) strengthStatusEl.textContent = '‚Ä¢ Si≈Ça: --';
                if (btcStatusEl) btcStatusEl.textContent = '‚Ä¢ BTC: --';
                if (changeStatusEl) changeStatusEl.textContent = '‚Ä¢ 24H: --';
                if (commentaryEl) commentaryEl.textContent = 'Genius w trybie offline ‚Äî u≈ºyj danych demonstracyjnych.';
                if (signalBadgeEl) signalBadgeEl.textContent = '--';
                if (signalStrengthEl) signalStrengthEl.textContent = 'CONFIDENCE: --';
                if (signalStrengthFillEl) signalStrengthFillEl.style.width = '0%';
                latestGeniusCommentary = '';
                renderQuantPanel(null);
                renderLiveBias(null);
                return;
            }

            const signal = (payload.signal || 'NEUTRAL').toUpperCase();
            const strength = formatStrengthLabel(payload.strength);
            const strengthScore = typeof payload.strength_score === 'number' && Number.isFinite(payload.strength_score)
                ? Math.round(payload.strength_score * 100)
                : null;

            const confidenceText = strengthScore !== null ? `CONFIDENCE: ${strengthScore}%` : `CONFIDENCE: ${strength}`;
            if (signalStrengthEl) signalStrengthEl.textContent = confidenceText;
            if (signalStrengthFillEl) {
                const fillPercent = strengthScore !== null ? Math.max(0, Math.min(100, strengthScore)) : 0;
                signalStrengthFillEl.style.width = `${fillPercent}%`;
            }

            if (signalBadgeEl) {
                const emoji = geniusSignalEmoji[signal] || '‚Ä¢';
                signalBadgeEl.textContent = `${emoji} ${signal}`;
            }

            if (signalStatusEl) {
                const emoji = geniusSignalEmoji[signal] || '‚Ä¢';
                signalStatusEl.textContent = `‚Ä¢ Sygna≈Ç: ${emoji} ${signal}`;
            }

            if (strengthStatusEl) {
                const suffix = strengthScore !== null ? ` (${strengthScore}%)` : '';
                strengthStatusEl.textContent = `‚Ä¢ Si≈Ça: ${strength}${suffix}`;
            }

            if (btcStatusEl) {
                const btcText = formatNumber(payload.btc_price, 0);
                btcStatusEl.textContent = `‚Ä¢ BTC: $${btcText}`;
            }

            if (changeStatusEl) {
                if (typeof payload.change_24h === 'number' && Number.isFinite(payload.change_24h)) {
                    const sign = payload.change_24h >= 0 ? '+' : '';
                    changeStatusEl.textContent = `‚Ä¢ 24H: ${sign}${payload.change_24h.toFixed(2)}%`;
                } else {
                    changeStatusEl.textContent = '‚Ä¢ 24H: --';
                }
            }

            if (commentaryEl) {
                const commentary = payload.commentary || 'Brak komentarza z silnika Genius.';
                commentaryEl.innerHTML = `<div style="margin-bottom:4px; font-weight:600;">${commentary}</div>`;
                latestGeniusCommentary = commentary;
            }

            renderLiveBias(payload.liveBias);
            renderQuantPanel(payload.quant);
        }

        async function updateGeniusCommentary() {
            try {
                const response = await fetch(`${API_BASE}/api/genius/commentary?symbol=BTCUSDT`, { cache: 'no-store' });
                if (response.ok) {
                    const payload = await response.json();
                    if (payload && payload.ok) {
                        applyGeniusPayload(payload);
                        return;
                    }
                    console.warn('Genius API responded without ok flag', payload);
                } else {
                    console.warn('Genius API HTTP error', response.status);
                }
            } catch (error) {
                console.log('Genius API offline, fallback activated.', error);
            }

            applyGeniusPayload(null);
        }

        async function playGeniusAudio(lang) {
            const statusEl = document.getElementById('geniusAudioStatus');
            if (statusEl) {
                statusEl.textContent = 'Generujƒô audio...';
            }
            try {
                const url = new URL(`${API_BASE}/api/genius/audio`);
                if (lang) {
                    url.searchParams.set('lang', lang);
                }
                const response = await fetch(url.toString());
                if (!response.ok) throw new Error('Audio API error');
                const data = await response.json();
                if (!data.ok || !data.audioBase64) throw new Error(data.error || 'Brak audio');
                const audioSrc = `data:${data.mimeType || 'audio/mpeg'};base64,${data.audioBase64}`;
                if (geniusAudioHandle) {
                    geniusAudioHandle.pause();
                }
                geniusAudioHandle = new Audio(audioSrc);
                await geniusAudioHandle.play();
                if (statusEl) {
                    statusEl.textContent = `Odtwarzanie (${(data.language || lang || 'pl').toUpperCase()})`;
                }
                geniusAudioHandle.onended = () => {
                    if (statusEl) statusEl.textContent = 'Gotowe';
                };
            } catch (err) {
                console.log('Audio TTS error', err);
                if (statusEl) {
                    statusEl.textContent = 'B≈ÇƒÖd audio, spr√≥buj ponownie';
                }
            }
        }

        setInterval(updateTime, 1000);
        updateTime();
        setInterval(updateGeniusCommentary, 10000);
        updateGeniusCommentary();

        const geniusAudioBtn = document.getElementById('geniusAudioPlay');
        const geniusAudioLang = document.getElementById('geniusAudioLang');
        if (geniusAudioBtn) {
            geniusAudioBtn.addEventListener('click', () => {
                const lang = geniusAudioLang ? geniusAudioLang.value : 'pl';
                playGeniusAudio(lang);
            });
        }

        window.addEventListener('load', playIntroAudio);
    </script>
</body>
</html>
